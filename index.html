<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Real-Time Chat with Google Sheet</title>
<style>
  body { font-family: Arial; background:#f5f5f5; display:flex; justify-content:center; padding-top:50px; }
  #chatContainer { width:400px; background:#fff; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.2);}
  #messages { height:300px; overflow-y:auto; border:1px solid #ccc; padding:10px; border-radius:5px; background:#fafafa;}
  input, button { padding:10px; margin-top:10px; width:100%; box-sizing:border-box;}
  .message { margin:5px 0;}
</style>
</head>
<body>
<div id="chatContainer">
<h2>Chat Room</h2>
<input type="text" id="roomCode" placeholder="Enter room code (optional)">
<input type="text" id="username" placeholder="Enter your name">
<div id="messages"></div>
<input type="text" id="messageInput" placeholder="Type your message">
<button onclick="sendMessage()">Send</button>
</div>

<script>
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzZ_85fTFY2OH9RiljNbicIKUIQ307qemL5ttaYydHRaFNstB_nlUeWRG0HZ0z1HIY3Ew/exec'; // replace with your Web App URL
let room = 'public';
let lastMessages = [];

// Change room code
document.getElementById('roomCode').addEventListener('change', () => {
  const code = document.getElementById('roomCode').value.trim();
  room = code || 'public';
  lastMessages = [];
  loadMessages();
});

// Send a message
function sendMessage() {
  const username = document.getElementById('username').value.trim() || 'Anonymous';
  const text = document.getElementById('messageInput').value.trim();
  if(!text) return;

  fetch(`${SCRIPT_URL}?action=add&room=${encodeURIComponent(room)}&username=${encodeURIComponent(username)}&message=${encodeURIComponent(text)}`)
  .then(() => {
    document.getElementById('messageInput').value = '';
  });
}

// Load messages and detect new ones
function loadMessages() {
  fetch(`${SCRIPT_URL}?action=get&room=${encodeURIComponent(room)}`)
  .then(res => res.json())
  .then(data => {
    const messagesDiv = document.getElementById('messages');

    // Only append new messages
    data.slice(lastMessages.length).forEach(msg => {
      const div = document.createElement('div');
      div.classList.add('message');
      div.textContent = `${msg.user}: ${msg.text}`;
      messagesDiv.appendChild(div);
    });

    if(data.length > lastMessages.length) {
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
      lastMessages = data;
    }
  });
}

// Check for new messages every 500ms
setInterval(loadMessages, 500);
loadMessages();
</script>
</body>
</html>
